'use strict';
var LIBRARY        = require('./_library')
  , $export        = require('./_export')
  , redefine       = require('./_redefine')
  , hide           = require('./_hide')
  , has            = require('./_has')
  , Iterators      = require('./_iterators')
  , $iterCreate    = require('./_iter-create')
  , setToStringTag = require('./_set-to-string-tag')
  , getPrototypeOf = require('./_object-gpo')
  , ITERATOR       = require('./_wks')('iterator')
  , BUGGY          = !([].keys && 'next' in [].keys()) // Safari has buggy iterators w/o `next`
  , FF_ITERATOR    = '@@iterator'
  , KEYS           = 'keys'
  , VALUES         = 'values';

var returnThis = function(){ return this; };

module.exports = function(Base, NAME, Constructor, next, DEFAULT, IS_SET, FORCED){
  $iterCreate(Constructor, NAME, next);
  var getMethod = function(kind){
    if(!BUGGY && kind in proto)return proto[kind];
    switch(kind){
      case KEYS: return function keys(){ return new Constructor(this, kind); };
      case VALUES: return function values(){ return new Constructor(this, kind); };
    } return function entries(){ return new Constructor(this, kind); };
  };
  var TAG        = NAME + ' Iterator'
    , DEF_VALUES = DEFAULT == VALUES
    , VALUES_BUG = false
    , proto      = Base.prototype
    , $native    = proto[ITERATOR] || proto[FF_ITERATOR] || DEFAULT && proto[DEFAULT]
    , $default   = $native || getMethod(DEFAULT)
    , $entries   = DEFAULT ? !DEF_VALUES ? $default : getMethod('entries') : undefined
    , $anyNative = NAME == 'Array' ? proto.entries || $native : $native
    , methods, key, IteratorPrototype, IteratorPrototypePrototype;
  // Fix native
  if($anyNative){
    IteratorPrototype = getPrototypeOf($anyNative.call(new Base()));
    if(IteratorPrototype !== Object.prototype && IteratorPrototype.next){
      // Set @@toStringTag to native iterators
      setToStringTag(IteratorPrototype, TAG, true);
      // according to the ES2015 standard, iterators for Map, Set, Array, and String
      // should have a prototype of %MapIteratorPrototype%, %SetIteratorPrototype%,
      // %ArrayIteratorPrototype%, and %StringIteratorPrototype%, respectively, and
      // each of *those* should have a prototype of %IteratorPrototype%.
      // however, some older engines don't have %IteratorPrototype%, which means that
      // an iterator instance won't have an @@iterator property, which is a bug.
      // in addition, some of those older engines don't allow setPrototypeOf, so you can't
      // just change the prototype chain. the solution here is to put @@iterator on
      // the %(Map|Set\Array|String)IteratorPrototype%, which is not strictly correct,
      // but to only do so in engines where we know the prototype chain is wrong.

      // IteratorPrototypePrototype is %IteratorPrototype% in standards-compliant
      // browsers.
      IteratorPrototypePrototype = getPrototypeOf(IteratorPrototype)
      if(!LIBRARY && IteratorPrototypePrototype && !has(IteratorPrototypePrototype, ITERATOR)){
        // this is a browser that doesn't correctly support %IteratorPrototype%, so
        // we put the @@iterator property on %(Map|Set|Array|String)IteratorPrototype%
        // instead.
        hide(IteratorPrototype, ITERATOR, returnThis);
      }
    }
  }
  // fix Array#{values, @@iterator}.name in V8 / FF
  if(DEF_VALUES && $native && $native.name !== VALUES){
    VALUES_BUG = true;
    $default = function values(){ return $native.call(this); };
  }
  // Define iterator
  if((!LIBRARY || FORCED) && (BUGGY || VALUES_BUG || !proto[ITERATOR])){
    hide(proto, ITERATOR, $default);
  }
  // Plug for library
  Iterators[NAME] = $default;
  Iterators[TAG]  = returnThis;
  if(DEFAULT){
    methods = {
      values:  DEF_VALUES ? $default : getMethod(VALUES),
      keys:    IS_SET     ? $default : getMethod(KEYS),
      entries: $entries
    };
    if(FORCED)for(key in methods){
      if(!(key in proto))redefine(proto, key, methods[key]);
    } else $export($export.P + $export.F * (BUGGY || VALUES_BUG), NAME, methods);
  }
  return methods;
};
